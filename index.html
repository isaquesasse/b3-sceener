<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B3 Pro | Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- DESIGN SYSTEM PERSONALIZADO --- */
        :root {
            --bg-body: #0f172a;       /* Slate 900 */
            --bg-sidebar: #1e293b;    /* Slate 800 */
            --bg-card: #1e293b;
            --accent-color: #38bdf8;  /* Sky 400 */
            --text-muted: #94a3b8;
            --border-color: #334155;
            --success-green: #4ade80;
            --danger-red: #f87171;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        /* Layout Grid */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link {
            color: var(--text-muted);
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link:hover, .nav-link.active {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
        }

        /* Conte√∫do Principal */
        .main-content {
            flex: 1;
            margin-left: 260px; /* Mesma largura da sidebar */
            padding: 2rem;
        }

        /* Cards de KPI */
        .kpi-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .kpi-title { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .kpi-value { font-size: 1.8rem; font-weight: 600; margin-top: 0.5rem; }

        /* Tabela Profissional */
        .table-container {
            background-color: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
            color: #e2e8f0;
        }

        .table thead th {
            background-color: #0f172a;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer; /* Indica que √© clic√°vel para ordenar */
            user-select: none;
        }
        
        .table thead th:hover { color: var(--accent-color); }

        .table tbody tr { transition: background-color 0.2s; border-bottom: 1px solid var(--border-color); }
        .table tbody tr:hover { background-color: rgba(255, 255, 255, 0.03); }

        .badge-graham { background-color: rgba(74, 222, 128, 0.15); color: var(--success-green); border: 1px solid rgba(74, 222, 128, 0.2); }
        .badge-risk { background-color: rgba(248, 113, 113, 0.15); color: var(--danger-red); border: 1px solid rgba(248, 113, 113, 0.2); }

        /* Bot√µes e Inputs */
        .btn-action {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
            border: none;
            transition: 0.2s;
        }
        .btn-action:hover { background-color: var(--accent-color); color: #000; }

        .search-box {
            background-color: #0f172a;
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            width: 100%;
        }
        .search-box:focus { outline: none; border-color: var(--accent-color); }

        /* Anima√ß√µes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        /* Modal */
        .modal-content { background-color: var(--bg-card); border: 1px solid var(--border-color); }
        .modal-header, .modal-footer { border-color: var(--border-color); }
        
        /* Mobile adjustment */
        @media (max-width: 768px) {
            .sidebar { display: none; } /* Em produ√ß√£o far√≠amos um menu hamburguer */
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <nav class="sidebar">
        <div class="brand">
            <i class="bi bi-graph-up-arrow"></i> B3 Pro
        </div>
        
        <div class="nav flex-column">
            <a href="#" class="nav-link active" onclick="switchView('dashboard')"><i class="bi bi-grid-1x2"></i> Dashboard</a>
            <a href="#" class="nav-link" onclick="switchView('portfolio')"><i class="bi bi-wallet2"></i> Minha Carteira</a>
            <a href="#" class="nav-link" onclick="toggleDidactic()"><i class="bi bi-book"></i> Aprenda</a>
            <div class="mt-4 text-muted small px-3">FILTROS R√ÅPIDOS</div>
            <a href="#" class="nav-link" onclick="applyFilter('graham')"><i class="bi bi-gem"></i> Graham Screener</a>
            <a href="#" class="nav-link" onclick="applyFilter('dividendos')"><i class="bi bi-cash-coin"></i> Dividendos</a>
            <a href="#" class="nav-link" onclick="applyFilter('reset')"><i class="bi bi-arrow-counterclockwise"></i> Limpar Filtros</a>
        </div>

        <div class="mt-auto">
            <div class="p-3 bg-dark rounded border border-secondary">
                <small class="text-muted d-block mb-1">Status API</small>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-success rounded-circle p-1" style="width:10px; height:10px;"> </span>
                    <span style="font-size: 0.85rem;">Online (Simulado)</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1">Vis√£o de Mercado</h2>
                <p class="text-muted mb-0">An√°lise fundamentalista e triagem de ativos.</p>
            </div>
            <div class="d-flex gap-3">
                <input type="text" id="searchInput" class="search-box" placeholder="Pesquisar Ticker (ex: WEGE3)..." onkeyup="handleSearch()">
            </div>
        </header>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Ativos Analisados</div>
                    <div class="kpi-value" id="kpiCount">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Oportunidades Graham</div>
                    <div class="kpi-value text-success" id="kpiGraham">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">M√©dia Dividend Yield</div>
                    <div class="kpi-value text-info" id="kpiDy">0%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-card">
                    <div class="kpi-title">Data An√°lise</div>
                    <div class="kpi-value" style="font-size: 1.2rem;">Hoje</div>
                </div>
            </div>
        </div>

        <div id="didacticSection" class="alert alert-info border-0 mb-4" style="background-color: #0c4a6e; color: #bae6fd; display: none;">
            <h5><i class="bi bi-lightbulb-fill"></i> Dicion√°rio do Investidor</h5>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>üíé F√≥rmula de Graham:</strong> <code>‚àö(22,5 √ó LPA √ó VPA)</code>. Busca empresas cujo pre√ßo de tela √© menor que o valor dos seus ativos e lucros.</p>
                    <p><strong>üõ°Ô∏è Margem de Seguran√ßa:</strong> A diferen√ßa percentual entre o Pre√ßo Justo e o Pre√ßo Atual. Quanto maior, mais seguro.</p>
                </div>
                <div class="col-md-6">
                    <p><strong>üí∞ M√©todo Bazin:</strong> Pre√ßo Teto = Dividendo pago / 0.06. Garante 6% de retorno ao ano via proventos.</p>
                    <p><strong>üìâ P/L (Pre√ßo/Lucro):</strong> Em quantos anos voc√™ recupera o investimento apenas com o lucro da empresa.</p>
                </div>
            </div>
        </div>

        <div class="table-container animate-fade">
            <div class="d-flex justify-content-between p-3 border-bottom border-secondary align-items-center">
                <h5 class="mb-0 fw-bold">Resultados da Busca</h5>
                <span class="badge bg-secondary" id="activeFilterBadge">Todos os Ativos</span>
            </div>
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th onclick="sortTable('symbol')">Ativo <i class="bi bi-arrow-down-up small"></i></th>
                            <th onclick="sortTable('price')">Pre√ßo <i class="bi bi-arrow-down-up small"></i></th>
                            <th onclick="sortTable('graham')">Pre√ßo Justo (Graham) <i class="bi bi-arrow-down-up small"></i></th>
                            <th onclick="sortTable('margem')">Margem Seg. <i class="bi bi-arrow-down-up small"></i></th>
                            <th onclick="sortTable('dy')">D.Y. <i class="bi bi-arrow-down-up small"></i></th>
                            <th onclick="sortTable('pl')">P/L <i class="bi bi-arrow-down-up small"></i></th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="stocksTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="stockModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalStockTitle">WEGE3</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-5 border-end border-secondary">
                        <h6 class="text-muted text-uppercase small">Fundamentos</h6>
                        <ul class="list-group list-group-flush" id="modalDataList">
                            </ul>
                    </div>
                    <div class="col-md-7">
                        <div style="height: 200px;">
                            <canvas id="detailChart"></canvas>
                        </div>
                        <div class="mt-3 p-3 rounded" style="background-color: rgba(255,255,255,0.05);">
                            <h6 class="text-accent"><i class="bi bi-robot"></i> An√°lise Autom√°tica</h6>
                            <p class="small mb-0 text-muted" id="modalAnalysisText">...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary btn-sm">Adicionar √† Carteira</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- ESTADO DA APLICA√á√ÉO ---
    const AppState = {
        rawData: [],
        displayData: [],
        filter: 'all',
        sort: { column: 'margem', order: 'desc' }, // Padr√£o: Melhores margens primeiro
        chartInstance: null
    };

    const API_TOKEN = 'token=wRDeSAirN1teSpR7afhgp3'; // Token p√∫blico da Brapi

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchMarketData();
    });

    // --- L√ìGICA DE NEG√ìCIO ---
    async function fetchMarketData() {
        const tableBody = document.getElementById('stocksTableBody');
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary"></div><div class="mt-2 text-muted">Analisando mercado...</div></td></tr>';

        try {
            // Em produ√ß√£o, aumente o limit ou use pagina√ß√£o
            const response = await fetch(`https://brapi.dev/api/quote/list?sortBy=volume&sortOrder=desc&limit=40&${API_TOKEN}`);
            const data = await response.json();

            // Processamento dos dados (Mockando fundamentos que faltam na API List free)
            AppState.rawData = data.stocks.map(stock => {
                const price = stock.close || 10;
                // GERADOR DE DADOS FUNDAMENTALISTAS (Simula√ß√£o para estudo)
                // Num sistema real, usar√≠amos endpoint /quote/{ticker}?fundamental=true
                const lpa = price * (Math.random() * 0.15 + 0.02); 
                const vpa = price * (Math.random() * 0.6 + 0.6);
                const dy = Math.random() * 14; 
                
                // C√°lculos Reais
                const graham = Math.sqrt(22.5 * lpa * vpa) || 0;
                const margem = graham > 0 ? ((graham - price) / price) * 100 : 0;
                const pl = lpa > 0 ? price / lpa : 0;

                return {
                    symbol: stock.stock,
                    name: stock.name,
                    price: price,
                    change: stock.change,
                    lpa, vpa, dy, pl,
                    graham, margem,
                    logo: stock.logo
                };
            });

            updateKPIs();
            applySort(); // Ordena e renderiza inicial

        } catch (error) {
            console.error(error);
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">Erro ao conectar com B3: ${error.message}</td></tr>`;
        }
    }

    function updateKPIs() {
        document.getElementById('kpiCount').innerText = AppState.rawData.length;
        
        // Conta quantas tem margem > 20%
        const opportunities = AppState.rawData.filter(s => s.margem > 20).length;
        document.getElementById('kpiGraham').innerText = opportunities;

        // M√©dia DY
        const avgDy = AppState.rawData.reduce((acc, curr) => acc + curr.dy, 0) / AppState.rawData.length;
        document.getElementById('kpiDy').innerText = avgDy.toFixed(2) + '%';
    }

    // --- FILTROS E ORDENA√á√ÉO ---

    function applyFilter(type) {
        AppState.filter = type;
        const badge = document.getElementById('activeFilterBadge');

        // L√≥gica de Filtro
        if (type === 'all' || type === 'reset') {
            AppState.displayData = [...AppState.rawData];
            badge.innerText = "Todos os Ativos";
            badge.className = "badge bg-secondary";
        } 
        else if (type === 'graham') {
            AppState.displayData = AppState.rawData.filter(s => s.margem > 20);
            badge.innerText = "Filtro: Graham (>20% Margem)";
            badge.className = "badge bg-success";
        } 
        else if (type === 'dividendos') {
            AppState.displayData = AppState.rawData.filter(s => s.dy > 6);
            badge.innerText = "Filtro: Dividendos (>6%)";
            badge.className = "badge bg-info text-dark";
        }

        // Re-aplica ordena√ß√£o atual no novo dataset filtrado
        applySort(null); 
    }

    function handleSearch() {
        const term = document.getElementById('searchInput').value.toLowerCase();
        if (term === '') {
            applyFilter(AppState.filter); // Restaura filtro atual
            return;
        }
        
        AppState.displayData = AppState.rawData.filter(s => 
            s.symbol.toLowerCase().includes(term) || 
            (s.name && s.name.toLowerCase().includes(term))
        );
        renderTable();
    }

    function sortTable(column) {
        // Alterna ordem se clicar na mesma coluna
        if (AppState.sort.column === column) {
            AppState.sort.order = AppState.sort.order === 'asc' ? 'desc' : 'asc';
        } else {
            AppState.sort.column = column;
            AppState.sort.order = 'desc'; // Padr√£o descrescente para n√∫meros financeiro √© melhor
        }
        applySort();
    }

    function applySort() {
        // Se displayData estiver vazio (in√≠cio), copia rawData
        if (AppState.displayData.length === 0 && document.getElementById('searchInput').value === '') {
            AppState.displayData = [...AppState.rawData];
        }

        const { column, order } = AppState.sort;

        AppState.displayData.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];

            // Tratamento para strings (Symbol)
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }

            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });

        renderTable();
    }

    // --- RENDERIZA√á√ÉO ---

    function renderTable() {
        const tbody = document.getElementById('stocksTableBody');
        tbody.innerHTML = '';
        
        // Remove anima√ß√£o anterior para reiniciar
        const container = document.querySelector('.table-container');
        container.classList.remove('animate-fade');
        void container.offsetWidth; // Trigger reflow
        container.classList.add('animate-fade');

        AppState.displayData.forEach(stock => {
            const isGrahamSafe = stock.margem > 0;
            const marginClass = isGrahamSafe ? 'text-success' : 'text-danger';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div class="fw-bold">${stock.symbol}</div>
                    <small class="text-muted" style="font-size:0.75rem">${stock.name || ''}</small>
                </td>
                <td class="fw-semibold">R$ ${stock.price.toFixed(2)}</td>
                <td>
                    R$ ${stock.graham.toFixed(2)}
                </td>
                <td>
                    <span class="badge ${stock.margem > 0 ? 'badge-graham' : 'badge-risk'}">
                        ${stock.margem.toFixed(1)}%
                    </span>
                </td>
                <td>${stock.dy.toFixed(1)}%</td>
                <td>${stock.pl.toFixed(1)}x</td>
                <td>
                    <button class="btn btn-sm btn-action" onclick="openDetails('${stock.symbol}')">
                        <i class="bi bi-eye"></i> Ver
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- INTERA√á√ÉO MODAL ---

    function openDetails(symbol) {
        const stock = AppState.rawData.find(s => s.symbol === symbol);
        if (!stock) return;

        // 1. Preencher T√≠tulo
        document.getElementById('modalStockTitle').innerHTML = `
            ${symbol} <span class="text-muted fw-light fs-6 ms-2">R$ ${stock.price.toFixed(2)}</span>
        `;

        // 2. Preencher Lista
        const listHtml = `
            <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                <span>Pre√ßo Justo (Graham)</span> <strong>R$ ${stock.graham.toFixed(2)}</strong>
            </li>
            <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                <span>Margem de Seguran√ßa</span> <strong class="${stock.margem > 0 ? 'text-success' : 'text-danger'}">${stock.margem.toFixed(2)}%</strong>
            </li>
            <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                <span>Dividend Yield</span> <strong>${stock.dy.toFixed(2)}%</strong>
            </li>
            <li class="list-group-item bg-transparent text-light border-secondary d-flex justify-content-between">
                <span>P/L (Anos de Retorno)</span> <strong>${stock.pl.toFixed(1)} anos</strong>
            </li>
        `;
        document.getElementById('modalDataList').innerHTML = listHtml;

        // 3. An√°lise de Texto
        let text = "";
        if (stock.margem > 20 && stock.dy > 6) text = "Excelente oportunidade te√≥rica. A√ß√£o descontada e pagadora de dividendos.";
        else if (stock.margem > 20) text = "A√ß√£o barata segundo Graham (Value Investing). Verifique se os lucros s√£o recorrentes.";
        else if (stock.dy > 8) text = "Poss√≠vel 'Vaca Leiteira'. Paga altos dividendos, mas est√° cara no patrim√¥nio.";
        else text = "Aten√ß√£o: O mercado precifica esta a√ß√£o acima do valor patrimonial calculado. Pode ser uma empresa de alto crescimento (Growth) ou estar cara.";
        document.getElementById('modalAnalysisText').innerText = text;

        // 4. Gr√°fico (Simulado)
        renderChart(symbol, stock.price);

        // 5. Abrir Modal (M√©todo Oficial Bootstrap 5)
        const modalEl = document.getElementById('stockModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    function renderChart(symbol, basePrice) {
        const ctx = document.getElementById('detailChart').getContext('2d');
        
        if (AppState.chartInstance) {
            AppState.chartInstance.destroy();
        }

        // Simula hist√≥rico (random walk)
        const history = [];
        let current = basePrice;
        for(let i=0; i<30; i++) {
            history.push(current);
            current = current * (1 + (Math.random() * 0.04 - 0.02));
        }

        AppState.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 30}, (_, i) => `Dia ${i+1}`),
                datasets: [{
                    label: 'Cota√ß√£o 30D',
                    data: history,
                    borderColor: '#38bdf8',
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { grid: { color: '#334155' } }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    }

    function toggleDidactic() {
        const el = document.getElementById('didacticSection');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function switchView(viewName) {
        // Exemplo simples de navega√ß√£o SPA (Single Page)
        if(viewName === 'dashboard') {
            document.querySelector('.table-container').style.display = 'block';
            document.querySelector('.row.mb-4').style.display = 'flex'; // KPIs
        } else if (viewName === 'portfolio') {
            alert('Funcionalidade "Minha Carteira" em desenvolvimento!');
        }
    }
</script>
</body>
</html>
