<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B3 Screener Pro | Market Wide</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #0b0e14;
            --bg-panel: #151a23;
            --border-color: #2a3441;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: #e2e8f0;
        }

        /* Navbar estilo App */
        .navbar-custom {
            background: rgba(21, 26, 35, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        /* Cards */
        .metric-card {
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        .metric-card:hover { transform: translateY(-2px); border-color: var(--primary); }

        /* Tabela */
        .table-container {
            background-color: var(--bg-panel);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .table-custom { --bs-table-bg: transparent; color: #cbd5e1; margin-bottom: 0; }
        .table-custom th {
            background-color: #1e2532;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            padding: 1rem;
        }
        .table-custom td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .table-custom tr:last-child td { border-bottom: none; }
        .table-custom tr:hover { background-color: rgba(59, 130, 246, 0.05); }

        /* Badges */
        .badge-soft-success { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-soft-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-soft-warning { background: rgba(245, 158, 11, 0.15); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }

        /* Inputs */
        .search-input {
            background-color: #0b0e14;
            border: 1px solid var(--border-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            width: 300px;
        }
        .search-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

        /* Loading */
        .loader-bar { height: 3px; width: 100%; background: #1e2532; position: fixed; top: 0; left: 0; z-index: 9999; }
        .loader-progress { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="loader-bar"><div class="loader-progress" id="progressBar"></div></div>

<nav class="navbar navbar-custom fixed-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold text-white" href="#">
            <i class="bi bi-rocket-takeoff-fill text-primary"></i> B3<span class="text-primary">Screener</span>
        </a>
        <div class="d-flex gap-3 align-items-center">
            <div class="text-end d-none d-md-block">
                <small class="text-muted d-block" style="font-size: 0.7rem;">DADOS BRAPI.DEV</small>
                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">‚óè Online</span>
            </div>
        </div>
    </div>
</nav>

<div class="container py-5 mt-5">
    
    <div class="row align-items-end mb-5">
        <div class="col-md-7">
            <h1 class="fw-bold mb-2">An√°lise de Mercado</h1>
            <p class="text-muted lead mb-0">Explore fundamentos, Graham e Bazin em tempo real.</p>
        </div>
        <div class="col-md-5 text-md-end mt-3 mt-md-0">
            <div class="d-flex justify-content-end gap-2">
                <input type="text" id="globalSearch" class="search-input" placeholder="Pesquisar Ticker (ex: KLBN11)...">
                <button class="btn btn-primary" onclick="handleSearchManual()"><i class="bi bi-search"></i></button>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold">A√ß√µes Carregadas</small>
                        <h2 class="fw-bold mt-2" id="kpiTotal">0</h2>
                    </div>
                    <i class="bi bi-layers text-primary fs-4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold">Oportunidades Graham</small>
                        <h2 class="fw-bold mt-2 text-success" id="kpiGraham">0</h2>
                    </div>
                    <i class="bi bi-gem text-success fs-4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold">Pagadoras (DY > 6%)</small>
                        <h2 class="fw-bold mt-2 text-warning" id="kpiDy">0</h2>
                    </div>
                    <i class="bi bi-piggy-bank text-warning fs-4"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <small class="text-muted text-uppercase fw-bold">Baratas (P/VP < 1)</small>
                        <h2 class="fw-bold mt-2 text-info" id="kpiCheap">0</h2>
                    </div>
                    <i class="bi bi-tag text-info fs-4"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3 overflow-auto pb-2">
        <button class="btn btn-outline-secondary btn-sm rounded-pill px-3 active" onclick="resetFilters()">Todos</button>
        <button class="btn btn-outline-success btn-sm rounded-pill px-3" onclick="filterData('graham')">üíé Graham Positivo</button>
        <button class="btn btn-outline-warning btn-sm rounded-pill px-3" onclick="filterData('dividend')">üí∞ Dividendos > 6%</button>
        <button class="btn btn-outline-info btn-sm rounded-pill px-3" onclick="filterData('cheap')">üìâ Abaixo do VPA</button>
    </div>

    <div class="table-container mb-4">
        <div class="table-responsive">
            <table class="table table-custom align-middle">
                <thead>
                    <tr>
                        <th onclick="sortData('symbol')">Ativo <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th onclick="sortData('price')">Pre√ßo <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th onclick="sortData('graham')">Pre√ßo Justo (Graham)</th>
                        <th onclick="sortData('margem')">Margem Seg. <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th onclick="sortData('dy')">D.Y. (12m) <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th onclick="sortData('pl')">P/L <i class="bi bi-arrow-down-up small ms-1"></i></th>
                        <th class="text-end">Detalhes</th>
                    </tr>
                </thead>
                <tbody id="stocksTableBody">
                    </tbody>
            </table>
        </div>
        <div class="p-3 text-center border-top border-secondary">
            <button id="btnLoadMore" class="btn btn-secondary w-100" onclick="loadNextBatch()">
                <i class="bi bi-arrow-down-circle"></i> Carregar Mais A√ß√µes
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background-color: #1e2532; color: #fff; border: 1px solid #334155;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title fw-bold" id="modalTitle">Ativo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-5">
                         <div class="p-3 rounded bg-dark border border-secondary mb-3">
                            <h6 class="text-muted text-uppercase small">Fundamentos</h6>
                            <div class="d-flex justify-content-between mb-2"><span>LPA (Lucro):</span> <strong id="mdLpa">--</strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>VPA (Patrim√¥nio):</span> <strong id="mdVpa">--</strong></div>
                            <div class="d-flex justify-content-between mb-0"><span>P/L (Retorno):</span> <strong id="mdPl">--</strong></div>
                        </div>
                        <div class="p-3 rounded bg-dark border border-secondary">
                            <h6 class="text-muted text-uppercase small">Avalia√ß√£o</h6>
                            <p id="mdAnalysis" class="small mb-0">...</p>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <canvas id="detailChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- CONFIGURA√á√ÉO ---
    const API_TOKEN = 'wRDeSAirN1teSpR7afhgp3'; // Sua chave
    
    // Lista "Mega" com as principais a√ß√µes da B3 (IBOV + SMLL + IFIX principais)
    // Isso simula "Ver Todas" cobrindo 99% do que importa.
    const ALL_TICKERS = [
        "VALE3", "PETR4", "ITUB4", "BBDC4", "BBAS3", "WEGE3", "ABEV3", "ELET3", "RENT3", "BPAC11", 
        "SUZB3", "ITSA4", "HAPV3", "RDOR3", "GGBR4", "PRIO3", "CSAN3", "RAIL3", "VBBR3", "B3SA3", 
        "EQTL3", "LREN3", "VIVT3", "TIMS3", "CMIG4", "UGPA3", "CPLE6", "EMBR3", "TOTS3", "SBSP3", 
        "ENEV3", "RADL3", "BRFS3", "JBSS3", "CSNA3", "MGLU3", "VIIA3", "ASAI3", "CRFB3", "HYPE3", 
        "MULT3", "CPFE3", "GOAU4", "CCRO3", "EGIE3", "CIEL3", "KLBN11", "TAEE11", "ALOS3", "BBSE3", 
        "CXSE3", "FLRY3", "MRVE3", "EZTC3", "CYRE3", "CVCB3", "PETZ3", "SOMA3", "ARZZ3", "SMTO3",
        "PSSA3", "IRBR3", "USIM5", "GOLL4", "AZUL4", "SLCE3", "STBP3", "MRFG3", "BEEF3", "AURE3"
    ];

    let processedData = []; // Armazena os dados j√° buscados
    let currentIndex = 0;   // Controle da pagina√ß√£o
    const BATCH_SIZE = 15;  // Quantas carregar por vez (para n√£o estourar API e URL)
    let chartInstance = null;

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        loadNextBatch(); // Carrega as primeiras 15
    });

    // --- SISTEMA DE PAGINA√á√ÉO (BATCH) ---
    async function loadNextBatch() {
        const btn = document.getElementById('btnLoadMore');
        const progress = document.getElementById('progressBar');
        
        if (currentIndex >= ALL_TICKERS.length) {
            btn.innerText = "Todas as a√ß√µes listadas carregadas";
            btn.disabled = true;
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Carregando...';
        progress.style.width = '70%';

        // Pega os pr√≥ximos tickers
        const batch = ALL_TICKERS.slice(currentIndex, currentIndex + BATCH_SIZE);
        const tickersString = batch.join(',');

        try {
            const url = `https://brapi.dev/api/quote/${tickersString}?token=${API_TOKEN}&fundamental=true&dividends=true`;
            const res = await fetch(url);
            const json = await res.json();
            
            // Processa os dados
            const newStocks = processApiData(json.results);
            
            // Adiciona ao array global (evita duplicatas se buscar manual depois)
            newStocks.forEach(stock => {
                if(!processedData.find(s => s.symbol === stock.symbol)) {
                    processedData.push(stock);
                }
            });

            currentIndex += BATCH_SIZE;
            renderTable(processedData);
            updateKPIs();
            
        } catch (error) {
            console.error("Erro no batch:", error);
            alert("Erro ao carregar mais a√ß√µes. Tente novamente em instantes.");
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-down-circle"></i> Carregar Mais A√ß√µes';
            progress.style.width = '100%';
            setTimeout(() => progress.style.width = '0%', 500);
            
            // Se acabou a lista, desativa bot√£o
            if (currentIndex >= ALL_TICKERS.length) {
                btn.style.display = 'none';
            }
        }
    }

    // --- BUSCA MANUAL (Se a a√ß√£o n√£o estiver na lista) ---
    async function handleSearchManual() {
        const input = document.getElementById('globalSearch');
        const ticker = input.value.toUpperCase().trim();
        if(!ticker) return;

        // Verifica se j√° temos os dados
        const exists = processedData.find(s => s.symbol === ticker);
        if(exists) {
            // Filtra a tabela visualmente
            renderTable([exists]);
            return;
        }

        // Se n√£o tem, busca na API
        const btn = document.querySelector('.bi-search').parentNode;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const url = `https://brapi.dev/api/quote/${ticker}?token=${API_TOKEN}&fundamental=true&dividends=true`;
            const res = await fetch(url);
            const json = await res.json();
            
            if(json.results && json.results.length > 0) {
                const stock = processApiData(json.results)[0];
                processedData.unshift(stock); // Adiciona no topo
                renderTable(processedData);
                updateKPIs();
            } else {
                alert("A√ß√£o n√£o encontrada!");
            }
        } catch(e) {
            alert("Erro ao buscar a√ß√£o. Verifique o c√≥digo.");
        } finally {
            btn.innerHTML = '<i class="bi bi-search"></i>';
        }
    }

    // --- L√ìGICA DE DADOS ---
    function processApiData(apiResults) {
        return apiResults.map(stock => {
            const price = stock.regularMarketPrice || 0;
            
            // Tratamento de falhas da API (Dados nulos)
            const pl = stock.priceEarnings || 0;
            const lpa = stock.earningsPerShare || (pl !== 0 ? price / pl : 0);
            // Fallback para VPA (Estima√ß√£o conservadora se vier null, para n√£o quebrar UI)
            const vpa = stock.bookValuePerShare || price; 
            const dy = stock.logStock && stock.logStock.dividendYield ? stock.logStock.dividendYield : 0;

            // C√°lculos
            let graham = 0;
            if(lpa > 0 && vpa > 0) graham = Math.sqrt(22.5 * lpa * vpa);
            
            const margem = graham > 0 ? ((graham - price) / price) * 100 : -99;

            return {
                symbol: stock.symbol,
                name: stock.longName || stock.symbol,
                price, lpa, vpa, pl, dy, graham, margem
            };
        });
    }

    // --- UI E FILTROS ---
    function renderTable(data) {
        const tbody = document.getElementById('stocksTableBody');
        tbody.innerHTML = '';

        data.forEach(s => {
            const badgeClass = s.margem > 20 ? 'badge-soft-success' : (s.margem > 0 ? 'badge-soft-warning' : 'badge-soft-danger');
            
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="fw-bold">${s.symbol}</div>
                        <small class="text-muted" style="font-size: 0.75rem">${s.name.substring(0,18)}</small>
                    </td>
                    <td>R$ ${s.price.toFixed(2)}</td>
                    <td class="text-info fw-bold">R$ ${s.graham.toFixed(2)}</td>
                    <td><span class="badge ${badgeClass}">${s.margem.toFixed(1)}%</span></td>
                    <td>${s.dy.toFixed(1)}%</td>
                    <td>${s.pl.toFixed(1)}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-light border-0" onclick="openDetails('${s.symbol}')"><i class="bi bi-eye-fill"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    function filterData(type) {
        let filtered = [];
        const btns = document.querySelectorAll('.d-flex.gap-2 button');
        btns.forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        switch(type) {
            case 'graham': filtered = processedData.filter(s => s.margem > 20); break;
            case 'dividend': filtered = processedData.filter(s => s.dy > 6); break;
            case 'cheap': filtered = processedData.filter(s => s.price < s.vpa); break;
            default: filtered = processedData;
        }
        renderTable(filtered);
    }
    
    function resetFilters() {
        renderTable(processedData);
        // Reset UI buttons active state logic if needed
    }

    function sortData(key) {
        processedData.sort((a,b) => {
            if(typeof a[key] === 'string') return a[key].localeCompare(b[key]);
            return b[key] - a[key]; // Descending
        });
        renderTable(processedData);
    }

    function updateKPIs() {
        document.getElementById('kpiTotal').innerText = processedData.length;
        document.getElementById('kpiGraham').innerText = processedData.filter(s => s.margem > 20).length;
        document.getElementById('kpiDy').innerText = processedData.filter(s => s.dy > 6).length;
        document.getElementById('kpiCheap').innerText = processedData.filter(s => s.price < s.vpa).length;
    }

    // --- DETALHES ---
    async function openDetails(symbol) {
        const stock = processedData.find(s => s.symbol === symbol);
        document.getElementById('modalTitle').innerText = `${symbol} - R$ ${stock.price.toFixed(2)}`;
        
        document.getElementById('mdLpa').innerText = stock.lpa.toFixed(2);
        document.getElementById('mdVpa').innerText = stock.vpa.toFixed(2);
        document.getElementById('mdPl').innerText = stock.pl.toFixed(2);

        let text = "Ativo com indicadores neutros.";
        if(stock.margem > 30 && stock.dy > 6) text = "üíé A√ß√£o 'Fil√© Mignon': Barata segundo Graham e boa pagadora de dividendos.";
        else if(stock.margem > 30) text = "Oportunidade de Valor: Pre√ßo muito abaixo do patrim√¥nio/lucro. Potencial de valoriza√ß√£o.";
        else if(stock.dy > 10) text = "Alto Dividendo: Verifique se o lucro √© recorrente ou se foi um evento n√£o recorrente.";
        document.getElementById('mdAnalysis').innerText = text;

        // Gr√°fico
        const ctx = document.getElementById('detailChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // Buscar hist√≥rico r√°pido (1 m√™s)
        try {
             const res = await fetch(`https://brapi.dev/api/quote/${symbol}?range=1mo&interval=1d&token=${API_TOKEN}`);
             const json = await res.json();
             const hist = json.results[0].historicalDataPrice;
             
             chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hist.map(h => new Date(h.date * 1000).toLocaleDateString().slice(0,5)),
                    datasets: [{
                        label: 'Pre√ßo',
                        data: hist.map(h => h.close),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { grid: { color: '#334155' } } }
                }
             });
        } catch(e) { console.log("Erro chart", e); }

        new bootstrap.Modal(document.getElementById('stockModal')).show();
    }

</script>
</body>
</html>
