<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B3 Screener - Isaque Personal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --bg-dark: #121212; --card-dark: #1e1e1e; }
        body { background-color: var(--bg-dark); color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: var(--card-dark); border: 1px solid #333; margin-bottom: 20px; }
        .metric-value { font-size: 1.5rem; font-weight: bold; }
        .text-graham { color: #00ff88; } /* Verde Matrix para Graham */
        .text-risk { color: #ff4d4d; }
        .didactic-box { background-color: #2c3e50; border-left: 4px solid #f1c40f; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        table { font-size: 0.9rem; }
        .table-dark { --bs-table-bg: var(--card-dark); }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1>üìà B3 Screener Pro</h1>
            <p class="text-muted">An√°lise fundamentalista automatizada</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-outline-info btn-sm" onclick="toggleTutorial()">üìö Como funciona a Bolsa?</button>
        </div>
    </div>

    <div id="tutorialSection" class="didactic-box" style="display:none;">
        <h4>üéì Miniaula: Indicadores Utilizados</h4>
        <ul>
            <li><strong>VPA (Valor Patrimonial por A√ß√£o):</strong> Quanto a empresa vale "no papel" (patrim√¥nio l√≠quido / n√∫mero de a√ß√µes).</li>
            <li><strong>LPA (Lucro por A√ß√£o):</strong> Quanto a empresa lucrou no √∫ltimo ano dividido pelo n√∫mero de a√ß√µes.</li>
            <li><strong>F√≥rmula de Graham:</strong> <code>‚àö(22,5 √ó LPA √ó VPA)</code>. Estima o pre√ßo justo. Se o pre√ßo atual for menor que isso, h√° uma "Margem de Seguran√ßa".</li>
            <li><strong>Pre√ßo Teto (Bazin):</strong> Focado em dividendos. Pega o quanto a empresa pagou de dividendo e divide por 6% (0.06). √â o m√°ximo que voc√™ deve pagar para ter um retorno de 6% a.a.</li>
        </ul>
    </div>

    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card p-3">
                <h5>üîç Filtros Inteligentes</h5>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="aplicarFiltro('graham')">üíé Oportunidades Graham</button>
                    <button class="btn btn-success" onclick="aplicarFiltro('dividendos')">üí∞ Dividendos Seguros (Bazin)</button>
                    <button class="btn btn-warning text-dark" onclick="aplicarFiltro('baratas')">üìâ Abaixo do VPA</button>
                    <button class="btn btn-secondary" onclick="aplicarFiltro('reset')">üîÑ Ver Todas</button>
                </div>
                <div class="mt-3">
                    <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" placeholder="Pesquisar ticker (ex: WEGE3, PETR4)..." onkeyup="searchTable()">
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-hover" id="stocksTable">
            <thead>
                <tr>
                    <th>Ativo</th>
                    <th>Pre√ßo Atual</th>
                    <th>Pre√ßo Justo (Graham)</th>
                    <th>Margem Seg.</th>
                    <th>Div. Yield</th>
                    <th>P/L</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="7" class="text-center">Carregando dados da B3... (Isso pode levar alguns segundos)</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="modalTitle">Detalhes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Indicadores</h6>
                        <ul id="modalIndicators" class="list-group list-group-flush rounded"></ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Gr√°fico (Simulado - √öltimos dias)</h6>
                        <canvas id="stockChart"></canvas>
                    </div>
                </div>
                <div class="mt-3 p-2 border border-warning rounded">
                    <small>üí° <strong>Interpreta√ß√£o:</strong> <span id="didacticExplanation"></span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ÉO ---
    // IMPORTANTE: Para funcionar 100%, voc√™ precisar√° de um token da Brapi.
    // O token abaixo √© p√∫blico/teste, pode falhar se tiver muito uso.
    // Crie sua conta gr√°tis em https://brapi.dev/ e troque aqui:
    const API_TOKEN = 'token=plublic'; 

    let allStocksData = []; // Armazena os dados brutos

    // --- FUN√á√ïES PRINCIPAIS ---

    async function fetchData() {
        // Busca lista de a√ß√µes (limitado para demonstra√ß√£o, a API free tem limites)
        // Na pr√°tica, buscar√≠amos a lista completa: https://brapi.dev/api/quote/list
        const url = `https://brapi.dev/api/quote/list?sortBy=volume&sortOrder=desc&limit=50&${API_TOKEN}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            // Processa e enriquece os dados com c√°lculos
            allStocksData = data.stocks.map(stock => {
                // Simula√ß√£o de dados fundamentais (A API de lista as vezes n√£o traz tudo no plano free, 
                // ent√£o aqui faremos uma estimativa baseada no pre√ßo para fins did√°ticos se o dado faltar)
                // Num app real, voc√™ faria uma chamada detalhada para cada stock clicada.
                
                // NOTA: A API 'list' da Brapi √© √≥tima, mas n√£o entrega LPA/VPA diretamente nela sempre.
                // Para este exemplo funcionar sem backend, vou simular LPA e VPA aleat√≥rios 
                // baseados no pre√ßo para voc√™ ver a MATEM√ÅTICA funcionando.
                // *Em produ√ß√£o, voc√™ usaria o endpoint /quote/{ticket} para pegar o real.*
                
                // --- MOCK DE DADOS FUNDAMENTALISTAS (PARA FINS DE DEMONSTRA√á√ÉO SEM BACKEND) ---
                const price = stock.close;
                const fakeLPA = price * (Math.random() * 0.15 + 0.05); // Lucro entre 5% e 20% do pre√ßo
                const fakeVPA = price * (Math.random() * 0.5 + 0.8);   // VPA pr√≥ximo ao pre√ßo
                const dy = Math.random() * 12; // DY entre 0 e 12%
                // --------------------------------------------------------------------------

                const graham = Math.sqrt(22.5 * fakeLPA * fakeVPA) || 0;
                const margem = graham > 0 ? ((graham - price) / price) * 100 : 0;
                const bazin = (dy * price / 100) / 0.06; // Pre√ßo Teto Bazin

                return {
                    symbol: stock.stock,
                    price: price,
                    lpa: fakeLPA,
                    vpa: fakeVPA,
                    dy: dy,
                    graham: graham,
                    margem: margem,
                    bazin: bazin,
                    change: stock.change
                };
            });

            renderTable(allStocksData);

        } catch (error) {
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="7" class="text-danger">Erro ao carregar API: ${error.message}</td></tr>`;
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        data.forEach(stock => {
            const row = `
                <tr>
                    <td><strong>${stock.symbol}</strong> <small class="${stock.change >= 0 ? 'text-success' : 'text-risk'}">${stock.change.toFixed(2)}%</small></td>
                    <td>R$ ${stock.price.toFixed(2)}</td>
                    <td class="text-graham">R$ ${stock.graham.toFixed(2)}</td>
                    <td>${stock.margem.toFixed(1)}%</td>
                    <td>${stock.dy.toFixed(1)}%</td>
                    <td>${(stock.price / stock.lpa).toFixed(1)}</td>
                    <td><button class="btn btn-sm btn-outline-light" onclick="showDetails('${stock.symbol}')">Ver</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- FILTROS L√ìGICOS ---

    function aplicarFiltro(tipo) {
        let filtered = [];
        
        switch(tipo) {
            case 'graham':
                // Filtra onde Pre√ßo Atual < Pre√ßo Graham (Margem positiva)
                filtered = allStocksData.filter(s => s.margem > 20); // Margem acima de 20%
                break;
            case 'dividendos':
                // Filtra DY acima de 6% (Bazin)
                filtered = allStocksData.filter(s => s.dy > 6); 
                break;
            case 'baratas':
                // Pre√ßo abaixo do valor patrimonial
                filtered = allStocksData.filter(s => s.price < s.vpa); 
                break;
            default:
                filtered = allStocksData;
        }
        renderTable(filtered);
    }

    function searchTable() {
        const term = document.getElementById('searchInput').value.toUpperCase();
        const filtered = allStocksData.filter(s => s.symbol.includes(term));
        renderTable(filtered);
    }

    // --- INTERATIVIDADE E GR√ÅFICOS ---

    function toggleTutorial() {
        const div = document.getElementById('tutorialSection');
        div.style.display = div.style.display === 'none' ? 'block' : 'none';
    }

    function showDetails(symbol) {
        const stock = allStocksData.find(s => s.symbol === symbol);
        if(!stock) return;

        document.getElementById('modalTitle').innerText = `${symbol} - An√°lise R√°pida`;
        
        // Popula indicadores
        const indicatorsHtml = `
            <li class="list-group-item bg-dark text-light">Pre√ßo: R$ ${stock.price.toFixed(2)}</li>
            <li class="list-group-item bg-dark text-light">Graham (Justo): R$ ${stock.graham.toFixed(2)}</li>
            <li class="list-group-item bg-dark text-light">Teto Bazin (6%): R$ ${stock.bazin.toFixed(2)}</li>
            <li class="list-group-item bg-dark text-light">Dividend Yield: ${stock.dy.toFixed(2)}%</li>
        `;
        document.getElementById('modalIndicators').innerHTML = indicatorsHtml;

        // Explica√ß√£o Did√°tica Din√¢mica
        let explanation = "";
        if (stock.price < stock.graham) {
            explanation = "Segundo Graham, esta a√ß√£o est√° DESCONTADA. O pre√ßo de tela √© menor que o valor intr√≠nseco calculado pelos lucros e patrim√¥nio.";
        } else {
            explanation = "O pre√ßo atual est√° acima do valor de Graham. O mercado pode estar precificando um grande crescimento futuro (Growth) que a f√≥rmula conservadora de Graham n√£o capta.";
        }
        document.getElementById('didacticExplanation').innerText = explanation;

        // Renderiza Gr√°fico Fake (Chart.js)
        renderChart(symbol);
        
        new bootstrap.Modal(document.getElementById('stockModal')).show();
    }

    let myChart = null;
    function renderChart(symbol) {
        const ctx = document.getElementById('stockChart').getContext('2d');
        if (myChart) myChart.destroy(); // Limpa gr√°fico anterior

        // Simulando dados hist√≥ricos para o gr√°fico (j√° que n√£o temos hist√≥rico na API list)
        const fakeHistory = Array.from({length: 10}, () => Math.floor(Math.random() * 5) + 20);

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out'],
                datasets: [{
                    label: `Cota√ß√£o ${symbol}`,
                    data: fakeHistory,
                    borderColor: '#00ff88',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } }
            }
        });
    }

    // Inicia
    fetchData();

</script>
</body>
</html>
